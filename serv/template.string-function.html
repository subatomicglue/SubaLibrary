<!-- Single Function Template -->
<div class="function-runner" style="max-width: 600px; margin: 2em auto; font-family: sans-serif; position: relative;">
  <h2><%=function_name%></h2>
  <p><%=DESCRIPTION optional%>:</p>

  <form id="functionForm" style="margin-bottom: 1em;">
    <textarea id="inputText" rows="6" style="width: 100%; padding: 0.5em; font-family: monospace;" placeholder="Paste text here..."></textarea><br><br>
    <button type="submit" style="padding: 0.5em 1em; background-color: #0078d7; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Submit & Copy
    </button>
    <!-- <button type="button" id="copyButton" style="padding: 0.5em 1em; margin-left: 0.5em; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Copy Output
    </button> -->
    <button type="button" id="clearButton" style="padding: 0.5em 1em; margin-left: 0.5em; background-color: #ff3333; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Clear
    </button>
  </form>

  <h3>Output:</h3>
  <pre id="outputText" style="background: #f3f3f3; padding: 1em; border: 1px solid #ccc; white-space: pre-wrap;"></pre>
</div>

<!-- Popup Toast -->
<div id="popupToast" style="
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 0.75em 1.25em;
  border-radius: 5px;
  opacity: 0;
  transition: opacity 0.5s ease;
  pointer-events: none;
  font-size: 14px;
"></div>

<script type="module">
  // Injected function code
  <%=function_code%>

  const fnName = "<%=function_name%>";
  const inputKey = `tools_${fnName}_input`;
  const outputKey = `tools_${fnName}_output`;

  // Popup toast
  function popup(message, duration = 2500) {
    const toast = document.getElementById("popupToast");
    toast.textContent = message;
    toast.style.opacity = "1";
    setTimeout(() => (toast.style.opacity = "0"), duration);
  }

  // Copy to clipboard
  async function copyOutput() {
    const text = document.getElementById("outputText").textContent.trim();
    if (!text) {
      popup("No output to copy.");
      return;
    }
    try {
      await navigator.clipboard.writeText(text);
      popup("Copied to clipboard!");
    } catch (err) {
      popup("Failed to copy: " + err.message);
    }
  }

  function clear() {
    document.getElementById("inputText").value = ""
    localStorage.setItem(inputKey, "");
    document.getElementById("outputText").textContent = "";
    localStorage.setItem(outputKey, "");
  }

  // Restore last state from localStorage
  window.addEventListener("DOMContentLoaded", () => {
    const savedInput = localStorage.getItem(inputKey);
    const savedOutput = localStorage.getItem(outputKey);
    if (savedInput) document.getElementById("inputText").value = savedInput;
    if (savedOutput) document.getElementById("outputText").textContent = savedOutput;

    const inputEl = document.getElementById("inputText");
    inputEl.addEventListener("input", () => {
      localStorage.setItem(inputKey, inputEl.value);

      document.getElementById("outputText").textContent = "";
      localStorage.setItem(outputKey, "");
      popup("Form is Saved");
    });
  });

  document.getElementById("clearButton").addEventListener("click", (e) => {
    clear();
    popup("Empty!");
  });

  // Persist on submit
  document.getElementById("functionForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const input = document.getElementById("inputText").value;
    const output = <%=function_name%>(input);

    document.getElementById("outputText").textContent = output;

    // Save state
    localStorage.setItem(inputKey, input);
    localStorage.setItem(outputKey, output);

    copyOutput();
  });

  // Copy button handler
  // document.getElementById("copyButton").addEventListener("click", copyOutput);
</script>

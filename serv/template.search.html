<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%=TITLE%></title>
    <style>
      /* Basic styling for the search button and input */
      #searchButton {
        cursor: pointer;
        border: none;
        background: none;
        outline: none;
        display: inline-flex;
        align-items: center;
      }

      #searchInput {
        display: none; /* Hidden by default */
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-left: 0.5rem;
      }

      .expanded {
        display: inline-block; /* Show when expanded */
      }
    </style>
    <style>
      body {
        background-color: #333333;
        color: #aaaaaa;
      }
      a { text-decoration: none; color: lightblue; }
      .search-result { margin-bottom: 1rem; }
      .search-result__heading { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.35rem; }
      .search-result__heading a { color: lightblue; }
      .transcript-button {
        border: 1px solid #666;
        border-radius: 0.35rem;
        padding: 0.15rem 0.55rem;
        font-size: 0.85rem;
        color: #6fb1ff;
        background: #444;
        display: inline-flex;
        align-items: center;
      }
      .search-result__body ul { margin: 0; padding-left: 1.25rem; }
    </style>
</head>
<body>
    <h1 id="TITLE"><%=TITLE%></h1>
    <p id="DESCRIPTION"><%=DESCRIPTION%></p>
    <form id="searchForm">
      <input type="text" id="searchTerm" name="searchTerm" placeholder="Enter search term" required>
      <button id="submitButton" type="submit">Search</button>&nbsp;<span id="buttonContainer"></span>&nbsp;
      <span class="search-help">
        <button type="button" class="search-help__summary" onclick="toggleSearchHelp()">+ search help</button>
      </span>
    </form>
    <div id="search-help-body" class="search-help__body">
      <div class="search-help__row">
        <div class="search-help__label">example: <code>&lt;specific word&gt;</code></div>
        <div class="search-help__example"><a href="?searchterm=there"><code>there</code></a></div>
      </div>

      <div class="search-help__row">
        <div class="search-help__label">example: <code>&lt;specific phrase&gt;</code></div>
        <div class="search-help__example"><a href="?searchterm=there was"><code>there was</code></a></div>
      </div>

      <div class="search-help__row">
        <div class="search-help__label">example: <code>&lt;keyword1&gt;,&lt;keyword2&gt;</code></div>
        <div class="search-help__example"><a href="?searchterm=train,plane,automobile"><code>train,plane,automobile</code></a></div>
      </div>
    </div>
    
    <style>
      .search-help {
        display: inline-flex;
        align-items: center;
        margin: 0.5rem 0;
        gap: 0.25rem;
      }
      .search-help__summary {
        cursor: pointer;
        display: inline-flex;
        user-select: none;
        font-weight: 600;
        border: none;
        background: none;
        color: inherit;
        padding: 0;
      }

      .search-help__body {
        margin-top: 0.5rem;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #444;
        box-sizing: border-box;
        width: 100%;
        display: none;
      }
      .search-help__body.active {
        display: block;
      }
      .search-help__row { margin: 0.4rem 0; }
      .search-help__label { opacity: 0.85; margin-bottom: 0.2rem; }
      .search-help__example code { font-weight: 700; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
    <ul id="results"></ul>

    <script>
      const ADDITIONAL_SEARCH_BUTTONS = <%=ADDITIONAL_SEARCH_BUTTONS%>;
      const searchInput = document.getElementById('searchTerm');
      const buttonContainer = document.getElementById('buttonContainer');
      const submitButton = document.getElementById('submitButton');
      const DESCRIPTION = "<%=DESCRIPTION%>";
      const descriptionParagraph = document.getElementById('DESCRIPTION');
      const searchHelpBody = document.getElementById('search-help-body');
      const searchHelpButton = document.querySelector('.search-help__summary');

      function getSearchTermFromURL() {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        if (params.has('searchterm'))
          return params.get('searchterm'); // Get the value of the searchterm
        return false;
      }

      function toggleSearchHelp() {
        if (!searchHelpBody || !searchHelpButton) return;
        const isActive = searchHelpBody.classList.toggle('active');
        searchHelpButton.textContent = isActive ? '- search help' : '+ search help';
      }

      function onSearchTermChange() {
        const searchTerm = searchInput.value.trim();
        buttonContainer.innerHTML = ""; // Clear old buttons

        if (!searchTerm) return;

        // update DESCRIPTION
        descriptionParagraph.innerHTML = DESCRIPTION.replace( /\${searchterm}/g, encodeURIComponent(searchTerm) );
        console.log( descriptionParagraph.innerHTML );

        // update BUTTONS
        for (const [label, urlTemplate] of Object.entries(ADDITIONAL_SEARCH_BUTTONS)) {
          const url = urlTemplate.replace( /\${searchterm}/g, encodeURIComponent(searchTerm));
          const linkButton = submitButton.cloneNode(true); // Clone the real button
          linkButton.type = "button"; // Avoid submitting the form
          linkButton.textContent = label;
          linkButton.style.opacity = 0.5;
          linkButton.title = `${label} - ${searchTerm}`
          linkButton.onclick = () => window.location.href = url;
          buttonContainer.appendChild(linkButton);
        }
      }

      const st = getSearchTermFromURL();
      if (st) document.getElementById('searchTerm').value = st
      onSearchTermChange();
      searchInput.addEventListener("input", onSearchTermChange);
      document.getElementById('searchForm').onsubmit = async function(event) {
        event.preventDefault();
        submitButton.disabled = true;
        submitButton.style.opacity = 0.5;
        submitButton.style.cursor = 'not-allowed';
        
        const searchTerm = document.getElementById('searchTerm').value;

        async function fetchWithTimeout(resource, options, timeoutMs = 15000) {
          const controller = new AbortController();
          const id = setTimeout(() => controller.abort(), timeoutMs);
          try {
            const response = await fetch(resource, {
              ...options,
              signal: controller.signal
            });
            return response;
          } finally {
            clearTimeout(id);
          }
        }

        try {
          const response = await fetchWithTimeout('<%=SEARCH_URL%>', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ searchTerm })
          });
          const results = await response.json();
          //console.log("results:", results)
          const resultsList = document.getElementById('results');
          resultsList.innerHTML = ''
          if (results.length == 0)
            resultsList.innerHTML = "no results"
          else
            results.forEach(result => {
              const li = document.createElement('li');
              li.className = 'search-result';

              const heading = document.createElement('div');
              heading.className = 'search-result__heading';

              if (result.link) {
                const linkEl = document.createElement('a');
                linkEl.href = result.link;
                linkEl.textContent = result.title;
                heading.appendChild(linkEl);
              } else {
                const textEl = document.createElement('span');
                textEl.textContent = result.title;
                heading.appendChild(textEl);
              }

              if (result.transcriptUrl) {
                const transcriptBtn = document.createElement('a');
                transcriptBtn.href = result.transcriptUrl;
                transcriptBtn.className = 'transcript-button';
                transcriptBtn.textContent = '[View full transcript]';
                heading.appendChild(transcriptBtn);
              }

              li.appendChild(heading);

              const body = document.createElement('div');
              body.className = 'search-result__body';
              body.innerHTML = result.body;
              li.appendChild(body);

              resultsList.appendChild(li);
            });

            // Update the URL with the search term (without reloading)
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('searchterm', searchTerm);
            window.history.replaceState({}, '', newUrl);
        } catch (err) {
          console.error("search failed", err);
          alert("Search failed.");
        } finally {
          // restore the button
          submitButton.disabled = false;
          submitButton.style.opacity = 1.0;
          submitButton.style.cursor = 'pointer';
        }
      };

      if (st && st != "") {
        document.getElementById('submitButton').click()
      }
    </script>
</body>
</html>
